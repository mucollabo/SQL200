-- ■ 예제_200_SQL로 머신러닝 구현하기22(K-MEANS)

-- 1. 머신러닝 모델이 학습할 테이블을 생성합니다.
	
DROP TABLE CHICAGO_CRIME; 

CREATE TABLE CHICAGO_CRIME
( C_ID	   NUMBER(10),
 CASE_NUMBER  VARCHAR2(10),
 CRIME_DATE    VARCHAR2(40), 
 PRIMARY_TYPE  VARCHAR2(40),
 DESCRIPTION   VARCHAR2(80),
 LOCATION_DESCRIPTION   VARCHAR2(50),	
 ARREST_YN    VARCHAR2(10),
 DOMESTIC     VARCHAR2(10),
 FBI_CODE      VARCHAR2(10),
 CRIME_YEAR   VARCHAR2(10),	
 LATITUDE      NUMBER(20,10),	
 LONGITUDE    NUMBER(20,10) 
);


--- Chicago_Crimes_2012_to_2017.csv 데이터를 입력합니다. 

SELECT COUNT(*) FROM CHICAGO_CRIME;
-- 1048575 행

-- 2. 머신러닝 구성 정보 테이블을 생성합니다. 

DROP TABLE SETTINGS_KM2;

CREATE TABLE SETTINGS_KM2
AS
SELECT *
   FROM TABLE (DBMS_DATA_MINING.GET_DEFAULT_SETTINGS)
   WHERE SETTING_NAME LIKE '%GLM%';

BEGIN

   INSERT INTO SETTINGS_KM2
      VALUES (DBMS_DATA_MINING.ALGO_NAME, 'ALGO_KMEANS');

   INSERT INTO SETTINGS_KM2
      VALUES (DBMS_DATA_MINING.PREP_AUTO, 'ON');

    INSERT INTO SETTINGS_KM2
      VALUES (DBMS_DATA_MINING.CLUS_NUM_CLUSTERS, 14);

   COMMIT;

END;
/


-- 3. 머신러닝 모델을 생성합니다. 

BEGIN
  DBMS_DATA_MINING.DROP_MODEL('MD_GLM_MODEL2');
END;
/


DROP TABLE KMEANS_RESULT2;

CREATE OR REPLACE VIEW VW_CHICAGO_CRIME
AS 
  SELECT C_ID, LATITUDE, LONGITUDE
    FROM CHICAGO_CRIME;

BEGIN 

   DBMS_DATA_MINING.CREATE_MODEL(
      MODEL_NAME            => 'MD_GLM_MODEL2',
      MINING_FUNCTION       => DBMS_DATA_MINING.CLUSTERING,
      DATA_TABLE_NAME       => 'VW_CHICAGO_CRIME',
      CASE_ID_COLUMN_NAME   => 'C_ID',
      TARGET_COLUMN_NAME    => NULL,
      SETTINGS_TABLE_NAME   => 'SETTINGS_KM2');
END;
/

-- 4. 생성한 머신러닝 모델로 군집화를 진행 합니다. 

BEGIN
   DBMS_DATA_MINING.APPLY (MODEL_NAME => 'MD_GLM_MODEL2',
                                         DATA_TABLE_NAME => 'VW_CHICAGO_CRIME',
                                         CASE_ID_COLUMN_NAME => 'C_ID',
                                         RESULT_TABLE_NAME => 'KMEANS_RESULT2');
END;
/


-- 5. 머신러닝 모델이 군집화한 결과를 확인합니다.  

SELECT T1.C_ID,
          T1.CLUSTER_ID,
          T1.PROBABILITY,
          T2.LATITUDE,
          T2.LONGITUDE
  FROM (SELECT C_ID, CLUSTER_ID, PROBABILITY
              FROM (SELECT T.*,
                                  MAX (PROBABILITY) OVER (PARTITION BY C_ID 
                                                                    ORDER BY PROBABILITY DESC) MAXP
                          FROM KMEANS_RESULT2 T)
            WHERE MAXP = PROBABILITY) T1, CHICAGO_CRIME T2
 WHERE T1.C_ID = T2.C_ID ORDER BY CLUSTER_ID;


-- 6. 14개의 군집 번호와 군집번호별 건수를 확인합니다. 

SELECT   T1.CLUSTER_ID , COUNT(*)
FROM (SELECT C_ID, CLUSTER_ID, PROBABILITY
            FROM (SELECT T.*,
                                MAX (PROBABILITY) OVER (PARTITION BY C_ID 
                                                                    ORDER BY PROBABILITY DESC) MAXP
                        FROM KMEANS_RESULT2 T)
           WHERE MAXP = PROBABILITY) T1, CHICAGO_CRIME T2
  WHERE T1.C_ID = T2.C_ID 
  GROUP BY T1.CLUSTER_ID;
